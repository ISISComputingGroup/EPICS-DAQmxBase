<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" dir="ltr" lang="en"><head>

	
						<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		  <meta name="generator" content="DokuWiki Release 2006-03-09b">
  <link rel="start" href="http://medsvr.tlabs.ac.za/">
  <link rel="contents" href="http://medsvr.tlabs.ac.za/epicsnidriverdaq?do=index" title="">
  <link rel="alternate" type="application/rss+xml" title="Recent Changes" href="http://medsvr.tlabs.ac.za/feed.php">
  <link rel="alternate" type="application/rss+xml" title="Current Namespace" href="http://medsvr.tlabs.ac.za/feed.php?mode=list&amp;ns=">
  <link rel="alternate" type="text/html" title="Plain HTML" href="http://medsvr.tlabs.ac.za/epicsnidriverdaq?do=export_xhtml">
  <link rel="alternate" type="text/plain" title="Wiki Markup" href="http://medsvr.tlabs.ac.za/epicsnidriverdaq?do=export_raw">
  <meta name="date" content="2007-08-23T14:21:34+0200">
  <meta name="robots" content="noindex,nofollow">
  <link rel="stylesheet" media="screen" type="text/css" href="wiki-manual_files/css_002.css">
  <link rel="stylesheet" media="print" type="text/css" href="wiki-manual_files/css.css">
  <script type="text/javascript" charset="utf-8" src="wiki-manual_files/js.php"></script><title>epicsnidriverdaq - MEDSVR Wiki</title>
		
					<link rel="shortcut icon" href="http://medsvr.tlabs.ac.za/lib/tpl/monobook/user/favicon.ico">
				<style type="text/css" media="screen,projection">/*<![CDATA[*/ @import "/lib/tpl/monobook/monobook/main.css"; /*]]>*/</style>

		<link rel="stylesheet" type="text/css" href="wiki-manual_files/commonPrint.css">
		<link rel="stylesheet" type="text/css" href="wiki-manual_files/print.css">

		<script type="text/javascript" src="wiki-manual_files/wikibits.js"></script>
		<style type="text/css" media="screen,projection">/*<![CDATA[*/
		@import "/lib/tpl/monobook/wikipedia/Common.css";
		@import "/lib/tpl/monobook/wikipedia/Monobook.css";
		@import "/lib/tpl/monobook/dokuwiki/doku.css";
		/*]]>*/</style><!--[if lt IE 5.5000]><style type="text/css">@import "/lib/tpl/monobook/monobook/IE50Fixes.css";</style><![endif]--><!--[if IE 5.5000]><style type="text/css">@import "/lib/tpl/monobook/monobook/IE55Fixes.css";</style><![endif]--><!--[if gte IE 6]><style type="text/css">@import "/lib/tpl/monobook/monobook/IE60Fixes.css";</style><![endif]--><!--[if IE]><script type="text/javascript" src="/lib/tpl/monobook/common/IEFixes.js"></script>
    <meta http-equiv="imagetoolbar" content="no" /><![endif]--></head><body ondblclick="" class="ns-0">
		<div id="globalWrapper">
			<div id="column-content">
				<div id="content">
					<a name="top" id="top"></a>
					<div id="siteNotice">
<!-- cachefile /udd0/home/www/html/data/cache/0/0b8bc61e1d99672549354c433a7b6b88.xhtml used -->
<div class="secedit2"><a href="http://medsvr.tlabs.ac.za/doku.php?id=:wiki:site_notice&amp;do=edit&amp;rev=1187871694">[Edit]</a></div></div>					<div id="bodyContent">
						<div class="dokuwiki">
							<!-- start content -->
																					<div id="catlinks"><p class="catlinks">Trace: <span class="bcsep">»</span> <span class="curid"><a href="http://medsvr.tlabs.ac.za/epicsnidriverdaq" class="breadcrumbs" title="epicsnidriverdaq">epicsnidriverdaq</a></span></p></div><div class="toc">
<div class="tocheader toctoggle" id="toc__header"><img alt="-" src="wiki-manual_files/arrow_up.gif" id="toc__hide"><img style="display: none;" alt="+" src="wiki-manual_files/arrow_down.gif" id="toc__show">Table of Contents</div>
<div id="toc__inside">

<ul class="toc">
<li class="level1"><div class="li"><span class="li"><a href="#epics_ni_driver" class="toc">EPICS NI driver</a></span></div>
<ul class="toc">
<li class="level2"><div class="li"><span class="li"><a href="#installing" class="toc">Installing</a></span></div></li>
<li class="level2"><div class="li"><span class="li"><a href="#epics_asyn_driver" class="toc">EPICS ASYN driver</a></span></div>
<ul class="toc">
<li class="level3"><div class="li"><span class="li"><a href="#overview" class="toc">Overview</a></span></div></li>
<li class="level3"><div class="li"><span class="li"><a href="#svn" class="toc">SVN</a></span></div></li>
<li class="level3"><div class="li"><span class="li"><a href="#asyn_module" class="toc">ASYN module</a></span></div></li>
</ul>
</li>
<li class="level2"><div class="li"><span class="li"><a href="#daqmx_ioc_commands" class="toc">DAQmx IOC commands</a></span></div></li>
<li class="level2"><div class="li"><span class="li"><a href="#daqmx_port_options" class="toc">DAQmx Port Options</a></span></div></li>
<li class="level2"><div class="li"><span class="li"><a href="#signal_generation" class="toc">Signal Generation</a></span></div>
<ul class="toc">
<li class="level3"><div class="li"><span class="li"><a href="#digital_generation" class="toc">Digital Generation</a></span></div></li>
</ul>
</li>
<li class="level2"><div class="li"><span class="li"><a href="#daq_modes_and_setting_up_tasks" class="toc">DAQ modes and Setting Up Tasks</a></span></div></li>
<li class="level2"><div class="li"><span class="li"><a href="#asyn_record_options" class="toc">ASYN record options</a></span></div></li>
<li class="level2"><div class="li"><span class="li"><a href="#custom_record" class="toc">Custom record</a></span></div></li>
<li class="level2"><div class="li"><span class="li"><a href="#driver_internals" class="toc">Driver Internals</a></span></div></li>
<li class="level2"><div class="li"><span class="li"><a href="#examples1" class="toc">Examples</a></span></div>
<ul class="toc">
<li class="level3"><div class="li"><span class="li"><a href="#scanner_simulation" class="toc">Scanner Simulation</a></span></div></li>
</ul>
</li>
<li class="level2"><div class="li"><span class="li"><a href="#trouble_shooting" class="toc">Trouble Shooting</a></span></div></li></ul>
</li></ul>
</div>
</div>

<h1><a name="epics_ni_driver" id="epics_ni_driver">EPICS NI driver</a></h1>
<div class="level1">

</div>
<div class="secedit"><form class="button" method="post" action="/epicsnidriverdaq"><div class="no"><input name="do" value="edit" type="hidden"><input name="lines" value="1-31" type="hidden"><input value="[Edit]" class="button" type="submit"></div></form></div>
<h2><a name="installing" id="installing">Installing</a></h2>
<div class="level2">

<p>
 The driver works with DAQmxBase (version 2.1) It supports RedHat, Suse and Mandrake. 
</p>

<p>
You need to install 2 rpms and then DAQmxBase from the CD.<br>
 Download 2 rpms and cd <a href="http://medsvr.tlabs.ac.za/epicsnidriverdaq" class="urlextern" title="http://medsvr.tlabs.ac.za/epicsnidriverdaq" rel="nofollow"> here</a>
</p>

<p>
Use rpm -i command to install rpms.<br>
 Then mount the cd with “mount -o loop”<br>
 cd to nivisa folder first.<br>
 Run the INSTALL script and answer YES to everything<br>
 Then goto the root cd folder.<br>
 Run the INSTALL script there and answer YES to everything.<br>

</p>

<p>
Now restart your PC. (YES you need to RESTART linux - stupid drivers)<br>
 now goto /usr/local/natinst/nidaqmxbase/bin<br>
 run lsdaq<br>
 you’re suppose to see a list of the NI cards detected.<br>
 If the cards not there it will not work.<br>

</p>

<p>
If the card is listed the EPICS stuff might work.<br>
 Remember to rerun lsdaq everytime you change the cards in the PC.
</p>

</div>

<h4><a name="notes_-_suse" id="notes_-_suse">Notes - SUSE</a></h4>
<div class="level4">

<p>
 To get DAQmx to install:<br>
 in: /lib/modules/2.6.16.13-4-smp/source/include/asm<br>
 do: ln -s asm-offsets.h asm_offsets.h<br>
 else the kernel configure doesn’t work
</p>

<p>
To compile medm ect on SUSE:<br>
 copy /usr/include/Xm/* from ubuntu into SUSE<br>
 ln -s libXm.so.3 libXm.so  (/usr/X11R6/lib/)
</p>

</div>
<div class="secedit"><form class="button" method="post" action="/epicsnidriverdaq"><div class="no"><input name="do" value="edit" type="hidden"><input name="lines" value="32-1196" type="hidden"><input value="[Edit]" class="button" type="submit"></div></form></div>
<h2><a name="epics_asyn_driver" id="epics_asyn_driver">EPICS ASYN driver</a></h2>
<div class="level2">

</div>
<div class="secedit"><form class="button" method="post" action="/epicsnidriverdaq"><div class="no"><input name="do" value="edit" type="hidden"><input name="lines" value="1197-1227" type="hidden"><input value="[Edit]" class="button" type="submit"></div></form></div>
<h3><a name="overview" id="overview">Overview</a></h3>
<div class="level3">

<p>
 This driver can work with most of the NI cards.
</p>

<p>
Current features:
</p>
<ul>
<li class="level1"><div class="li"> DAQ modes: Analog Input, Analog Output, Binary Input, Binary Output , Counter Output , Counter Input</div>
</li>
<li class="level1"><div class="li"> Configuration only limited by NI drivers</div>
</li>
<li class="level1"><div class="li"> I/O Interrupts or interval-SCAN modes available</div>
</li>
<li class="level1"><div class="li"> Supports NI Analog and Digital Triggering</div>
</li>
<li class="level1"><div class="li"> Many usefull IOC commands</div>
</li>
<li class="level1"><div class="li"> Most options can be changed/set with IOC commands and/or records</div>
</li>
<li class="level1"><div class="li"> Can be used with standard record</div>
</li>
<li class="level1"><div class="li"> Signal Generator functions</div>
</li>
<li class="level1"><div class="li"> Software trigger mode</div>
</li>
<li class="level1"><div class="li"> ASYN trace - for debugging</div>
</li>
</ul>

<p>
 It works with the DAQmxBase drivers. This is a major problem. But it is currently the best solution.
</p>

<p>
Any further questions can be sent to <a href="mailto:heinrichdt@tlabs.ac.za" class="mail JSnocheck" title="heinrichdt@tlabs.ac.za"> Heinrich du Toit</a>
</p>

</div>
<div class="secedit"><form class="button" method="post" action="/epicsnidriverdaq"><div class="no"><input name="do" value="edit" type="hidden"><input name="lines" value="1228-1973" type="hidden"><input value="[Edit]" class="button" type="submit"></div></form></div>
<h3><a name="svn" id="svn">SVN</a></h3>
<div class="level3">

<p>
 This driver is being together with DIAMOND light source.
</p>

<p>
Main person there responsible is Ulrik Pederson (ulrik.pederson@diamon.as.uk)
</p>

<p>
Browse SVN repository <a href="http://epics.svn.sourceforge.net/viewvc/epics/applications/trunk/DAQmxBase/" class="urlextern" title="http://epics.svn.sourceforge.net/viewvc/epics/applications/trunk/DAQmxBase/" rel="nofollow">http://epics.svn.sourceforge.net/viewvc/epics/applications/trunk/DAQmxBase/</a>
</p>

<p>
checkout svn: <strong> svn co <a href="https://epics.svn.sourceforge.net/svnroot/epics/applications/trunk/DAQmxBase" class="urlextern" title="https://epics.svn.sourceforge.net/svnroot/epics/applications/trunk/DAQmxBase" rel="nofollow">https://epics.svn.sourceforge.net/svnroot/epics/applications/trunk/DAQmxBase</a> </strong>
</p>

<p>
You will need special previliges on sourceforge if you want to commit to this repository.<br>
 email heinrichdt@tlabs.ac.za for more details.
</p>

</div>
<div class="secedit"><form class="button" method="post" action="/epicsnidriverdaq"><div class="no"><input name="do" value="edit" type="hidden"><input name="lines" value="1974-2473" type="hidden"><input value="[Edit]" class="button" type="submit"></div></form></div>
<h3><a name="asyn_module" id="asyn_module">ASYN module</a></h3>
<div class="level3">

<p>
 module name: drvDaqMxBase<br>
 sourcefile: drvDaqMxBase.c<br>
 header file required: NIDAQmxBase.h<br>
 dbd file: DAQmxBaseSupport.dbd
</p>

<p>
See Makefile if you want to add this to some other IOC.
</p>

<p>
See startup scripts under iocBoot/iocDAQmxBase for how to load the driver ect.<br>
 Commands explained below
</p>

</div>
<div class="secedit"><form class="button" method="post" action="/epicsnidriverdaq"><div class="no"><input name="do" value="edit" type="hidden"><input name="lines" value="2474-2787" type="hidden"><input value="[Edit]" class="button" type="submit"></div></form></div>
<h2><a name="daqmx_ioc_commands" id="daqmx_ioc_commands">DAQmx IOC commands</a></h2>
<div class="level2">

<p>
 <strong>DAQmxBaseConfig</strong> (portName, deviceName, Channelnr, acqType, options)<br>
 portName - ASYN port name to create or to add to<br>
 devicename - NI device name (e.g. dev1/ai0)<br>
 Channelnr - Channelnr inside ASYN port (start with 0)<br>
 acqType - “AI” ,”AO”, “BI”, “BO” or “COUNTER”<br>
 options - see <a href="http://medsvr.tlabs.ac.za/daqmx_port_options" class="wikilink2" title="daqmx_port_options">DAQmx Port Options</a>
</p>

<p>
<strong>DAQmxReset</strong> (DeviceName)<br>
 Currently this doesn’t work - think NI library is bugged
</p>

<p>
<strong>DAQmxChangeDeviceName</strong> (portname, channelnr, newdevicename)<br>
 Use this at run-time to change the devicename of a port
</p>

<p>
<strong>DAQmxPortOptions</strong> (portname, channelnr, options)<br>
 Use to add or override options given to a specific port/channel
</p>

<p>
<strong>DAQmxGen</strong> and <strong>DAQmxGenP</strong><br>
 See <a href="http://medsvr.tlabs.ac.za/signal_generation" class="wikilink2" title="signal_generation">Signal Generation</a>
</p>

<p>
<strong>DAQmxTrigger</strong> (portName, triggerSource, TriggerOptions)<br>
 Use this to enable trigger on a port<br>
 portname - ASYN port name<br>
 triggerSource - NI trigger Source <br>
 TriggerOptions - see <a href="http://medsvr.tlabs.ac.za/daqmx_port_options" class="wikilink2" title="daqmx_port_options">DAQmx Port Options</a>
</p>

<p>
<strong>DAQmxStart</strong> (portname)<br>
 Starts sampling on a ASYN port
</p>

</div>
<div class="secedit"><form class="button" method="post" action="/epicsnidriverdaq"><div class="no"><input name="do" value="edit" type="hidden"><input name="lines" value="2788-3794" type="hidden"><input value="[Edit]" class="button" type="submit"></div></form></div>
<h2><a name="daqmx_port_options" id="daqmx_port_options">DAQmx Port Options</a></h2>
<div class="level2">

<p>
 These are all options given to the IOC commands DAQmxBaseConfig,DAQmxPortOptions  or DAQmxTrigger
</p>

</div>

<h4><a name="terminal" id="terminal">Terminal</a></h4>
<div class="level4">

<p>
 To set the temination of the input type specify 1 of:<br>
 TerminalDef - Default<br>
 TerminalRSE<br>
 TerminalNRSE<br>
 TerminalDiff - Differential<br>

</p>

</div>

<h4><a name="read_mode" id="read_mode">Read Mode</a></h4>
<div class="level4">

<p> The default mode is a non-monster continuous mode. In the default
mode the driver will read the card as fast as it can. But it will stil
stop and start the NI task every time. And it will use limited sampling
mode when setting up the task. The problem is that if we put the card
in continuous sampling and the driver can’t read the samples fast
enough then a buffer overflow happens in side the driver. </p>

<p>
The second mode is single-shot mode. In this mode the driver only reads
the NI card when asked to. This will be done if the interface is read.
A record setup with SCAN = “x second(s)” is usually used for this mode.
</p>

<p>The last mode is Monster mode. In this mode continuous sampling is
used and the driver will need to read the data from the NI card faster
than sampling is done. 2 ways to assure this is to choose a slower
sampling rate or to get a faster pc.
</p>

<p>
The options:<br>
 Continuous - default<br>
 OneShot<br>
 MONSTER
</p>

</div>

<h4><a name="trigger_options" id="trigger_options">Trigger Options</a></h4>
<div class="level4">

<p>
 Edge options:<br>
 TriggerRising<br>
 TriggerFalling
</p>

<p>
The Rising/Falling options will enable triggering - one of them must be specified.
</p>

<p>
Type options:<br>
 TriggerDig - Digital triggering<br>
 TriggerAnlg - Analog triggering
</p>

<p>
Other:<br>
 T=level - Trigger level (only for Analog triggering)<br>
 p=presamples - Number of Pre-samples
</p>

</div>

<h5><a name="soft_trigger_options" id="soft_trigger_options">Soft Trigger Options</a></h5>
<div class="level5">

<p>
 S=mode - Soft trigger mode<br>
 0 - no soft triggering - default<br>
 1 - Soft trigger on first sample higher than triggerlevel<br>
 2 - Soft trigger on first sample lower than triggerlevel<br>
 3 - Soft trigger on rising edge going past triggerlevel<br>
 4 - Soft trigger on falling edge going past triggerlevel<br>

</p>

<p>
s=soft trigger channel number<br>

</p>

<p>In soft triggering you can use the pre-samples option also. If
presamples=x then soft trigger will only trigger within the first x
samples and not look further.
</p>

<p>
Soft trigger is still pretty much experimental. Only supported for Analog Input.
</p>

</div>

<h4><a name="counter_options" id="counter_options">Counter options</a></h4>
<div class="level4">

<p>
 For COUNTER (In) you must specify one of:<br>
 CIPeriod<br>
 CICountEdges<br>
 CIPulseWidth
</p>

<p>
IdleLow, IdleHigh - set Idle state - default = low<br>
 CountRising, CountFalling - edge option<br>
 CountUp, CountDown, CountExt - counting direction<br>
 CReadF64, CReadScalarF64, CReadScalarU32, CReadU32 - counter read modes overrrides
</p>

<p>
D=DutyCycle<br>
 d=delay (initial delay with counter)
</p>

<p>
Also uses F and N (see below)
</p>

</div>

<h4><a name="task_options" id="task_options">Task options</a></h4>
<div class="level4">

<p>
 m=min volts<br>
 M=max volts<br>
 F=Frequency of sampling<br>
 N=number of samples
</p>

<p>
C=clocksource  (e.g. C=/Dev1/PFIO) default=OnBoardClock
</p>

</div>

<h5><a name="notes" id="notes">Notes</a></h5>
<div class="level5">

<p>
Some cards (like the NI-622x cards) have internal ctrx channels.<br>
 You can in theory setup an internal counter on these to generate clock output and use that to driver a binary output signal<br>
 As in these cards OnBoardBlock doesn’t work.<br>
 (COUNTER not yet implemented - sorry)
</p>

</div>
<div class="secedit"><form class="button" method="post" action="/epicsnidriverdaq"><div class="no"><input name="do" value="edit" type="hidden"><input name="lines" value="3795-6846" type="hidden"><input value="[Edit]" class="button" type="submit"></div></form></div>
<h2><a name="signal_generation" id="signal_generation">Signal Generation</a></h2>
<div class="level2">

<p>
 The signal generation functions is for Analog Output only. Everything is done with the <strong>DAQmxGen</strong> IOC command.
</p>

<p>The signal generation works in an add-only principle. This means
that every call to DAQmxGen will only add to/modify the signal and will
not clear it unless specifically asked todo that. This way multiple
calls to DAQmxGen can be made to build up fairly complex signals.
</p>

</div>

<h4><a name="daqmxgen" id="daqmxgen">DAQmxGen</a></h4>
<div class="level4">

<p>
 DAQmxGen(portName, Channelnr, params)<br>
 portName - Asyn port name - already created<br>
 Channelnr - Channelnr on which to run Generations<br>
 params - see below
</p>

<p>
DAQmxGenP(params)<br>
 This function wil call DAQmxGen with the previously used PortName and Channelnr<br>
This is simply to make interactive commands easier in the IOC as you
don’t need to specify the portName and Channelnr everytime.
</p>

</div>

<h4><a name="params" id="params">Params</a></h4>
<div class="level4">

<p> First you need to specify a Generate options. (The are listed
below) This will tel DAQmxGen what type of function to add to the
signal. Then you need to specify the parameters for that options. (Only
1 option per DAQmxGen call!)
</p>

<p>
The parameters are A through Z.<br>
 Simple specify A=value or C=value ect.<br>
 all value’s are floating point number - but some will be converted to integers depening on the generation option.
</p>

<p>If a parameter is not specified a default value is used. Parameters
must be specified after the generation options is given in the params
string given to DAQmxGen.
</p>

</div>

<h5><a name="clear" id="clear">clear</a></h5>
<div class="level5">

<p> This is a special option as it can be specified together with the
other options as to tell DAQmxGen to clear the signal before
generation. It will make all samples inside the signal 0. You will need
to specify this option probably the first time - as signals aren’t
zero’d at startup.
</p>

</div>

<h5><a name="block" id="block">block</a></h5>
<div class="level5">

<p>
 Adds a block function.<br>
 A = number of samples at top<br>
 B = number of samples at bottom<br>
 C = Top Volts <br>
 D = Bottom Volts<br>

</p>

</div>

<h5><a name="random" id="random">Random</a></h5>
<div class="level5">

<p>
 Adds random noise<br>
 A = max (default = 1) B = min (default = -1) C = number of levels between min and max (default=255) D = Seed if non-zero
</p>

</div>

<h5><a name="triangle" id="triangle">Triangle</a></h5>
<div class="level5">

<p>
 Adds a triangle/saw function<br>
 A = Height (peek-to-peek) of triangle (def: 5)<br>
 B = Centre of triangle (def:0)<br>
 C = delta Volts per sample for upwards slope<br>
 D = delta Volts per sample for downwards slope<br>
 (C and D &gt; 0) - if C or D = 0 then the upwards edge is immediate (ie. no slope)<br>
 (C and D default = 0.1) E = Number of samples stationary at top<br>
 F = Number of samples stationary at bottom<br>
 (E and F default = 0)<br>

</p>

</div>

<h5><a name="offset" id="offset">Offset</a></h5>
<div class="level5">

<p>
 Adds an Offset<br>
 A = volts
</p>

</div>

<h5><a name="sin" id="sin">Sin</a></h5>
<div class="level5">

<p>
 Adds a sinusoidal wave<br>
 A = Radiants per samples (def: 0.1)<br>
 B = Amplitude (def: 2)<br>
 C = Offset (def: 0)<br>
 D = Starting radiants (def:0)<br>

</p>

</div>

<h5><a name="removeoffset" id="removeoffset">RemoveOffset</a></h5>
<div class="level5">

<p>
 Removes Offset from waveform
</p>

</div>

<h5><a name="block2" id="block2">block2</a></h5>
<div class="level5">

<p>
 Adds a single block into the waveform<br>
 A = starting sample number of block<br>
 B = number of samples the block will be<br>
 C = height of block (def:2) - can be negative also
</p>

</div>

<h5><a name="pulse" id="pulse">Pulse</a></h5>
<div class="level5">

<p>
 Adds a pulse to the waveform - used for scanner simulation<br>
 A = centre samples number of pulse<br>
 B = Amplitude (negative number allowed for inverse pulse)<br>
 C = Gravity factor (default: 0.7) - A smaller number will result in faster down fall on left and right of pulse<br>

</p>

</div>

<h5><a name="smoothrandom" id="smoothrandom">SmoothRandom</a></h5>
<div class="level5">

<p>
 Adds “Smooth” random noise<br>
 A = max volts<br>
 B = min volts<br>
 C = max delta between 2 samples (noise factor - not resulting signal)<br>
 D = seed if non-zero
</p>

</div>

<h5><a name="startendmatch" id="startendmatch">StartEndMatch</a></h5>
<div class="level5">

<p>
 This will modify the start and end of the signal so they will meet each other. <br>
 Will try todo this smoothly<br>
A = maximum rate of change. - A higher number will allow more drasting
changes but a lower number will result in more samples being changed.
</p>

</div>

<h5><a name="smooth" id="smooth">smooth</a></h5>
<div class="level5">

<p>
 Will smooth the function as in not permitting fast changes between samples<br>
 A = maximum delta volts allowed between 2 samples
</p>

</div>

<h5><a name="filter" id="filter">filter</a></h5>
<div class="level5">

<p>
 Filters the function - very simple/stupid filter<br>
 A = filter (higher = more filtering) default = 4
</p>

</div>

<h5><a name="buldge" id="buldge">buldge</a></h5>
<div class="level5">

<p>
 Adds a “Buldge” to the waveform - also used for scanner simulation<br>
 A = Centre of buldge<br>
 B = Width of buldge<br>
 C = Amplitude of buldge (can be negative)
</p>

</div>

<h5><a name="clearregion" id="clearregion">clearregion</a></h5>
<div class="level5">

<p>
 Smoothly clears a region by removing everything between start and end and replacing it with a smooth “line”.<br>
 A = start sample number<br>
 B = end sample number<br>
 If B &lt; A it will roll-around the end of the signal.
</p>

</div>

<h5><a name="scale" id="scale">Scale</a></h5>
<div class="level5">

<p>
 Will scale the samples<br>
 A = Scale factor<br>
 B = starting samples number (def:0)<br>
 C = ending samples number (def:0)<br>
 By default it will scale everything
</p>

</div>

<h4><a name="house_keeping" id="house_keeping">House keeping</a></h4>
<div class="level4">

<p>
 After generation the function will print out the difference in voltage between the first and last sample.
</p>

<p>
No effort is made to keep voltages within allowed limitations.
</p>

</div>
<div class="secedit"><form class="button" method="post" action="/epicsnidriverdaq"><div class="no"><input name="do" value="edit" type="hidden"><input name="lines" value="6847-11503" type="hidden"><input value="[Edit]" class="button" type="submit"></div></form></div>
<h3><a name="digital_generation" id="digital_generation">Digital Generation</a></h3>
<div class="level3">

<p> If DAQmxGen is called on a BO signal then the params is ignored and
a simple counter pattern is inserted. Starting with value 0 in samples
0 and counting onwards. </p>

</div>
<div class="secedit"><form class="button" method="post" action="/epicsnidriverdaq"><div class="no"><input name="do" value="edit" type="hidden"><input name="lines" value="11504-11698" type="hidden"><input value="[Edit]" class="button" type="submit"></div></form></div>
<h2><a name="daq_modes_and_setting_up_tasks" id="daq_modes_and_setting_up_tasks">DAQ modes and Setting Up Tasks</a></h2>
<div class="level2">

</div>

<h4><a name="overview1" id="overview1">Overview</a></h4>
<div class="level4">

<p>
 There are 6 DAQ mode options available: AI, AO, BI, BO, COUNTER, CO
</p>

<p>
The driver creates a port per task. And then uses addresses for the
channels inside the task. A task can have only 1 DAQ mode. So all
channels in a given task must be the same type.
</p>

<p>
A task can also have clock options and trigger options.
</p>

<p>Normally a task setup is done with DAQmxBaseConfig IOC commands.
Then afterwards records are connected to the signals/channls inside
this task/port.
</p>

<p>
task/port confusion?<br> In NI terms they are called tasks. But in
EPICS there is an ASYN port for every task. So for the purpose of this
driver the terms are almost interchangable.
</p>

<p>
signal/channel confusion?<br> Same as above. In IN terms a task has
1 or more channels. In ASYN a port has 1 or more signal differentiated
by integer numbers called addresses.
</p>

</div>

<h5><a name="examples" id="examples">examples</a></h5>
<div class="level5">

<p> In the folder iocBoot/iocDAQmxBase there is many different startup
scripts for the IOC that will do different setups. Please look at them
for examples of how todo things.
</p>

</div>

<h4><a name="analog_input" id="analog_input">Analog Input</a></h4>
<div class="level4">

<p>
 This is when you want to read in analog signals.
</p>

<p>
You can have a maximum of 1 AI task.  But this 1 task can have more than 1 Analog input channel.
</p>

<p>
All channels will have the same sampleRate.  And the number of Samples per channel is fixed for the task.
</p>

<p>
e.g.<br>
 DAQmxBaseConfig(”portname”, “Dev1/ai0”, 0, “AI” , “TerminalNRSE F=1000 N=300”)
</p>

</div>

<h4><a name="analog_output" id="analog_output">Analog Output</a></h4>
<div class="level4">

<p>
 For analog output. Most cards that have analog output will support single value output.
</p>

<p>
Some cards will support waveform output. The Signal Generator functionality is a good way to generate a waveform for output.
</p>

<p>
e.g.<br>
 This will setup an output channel that can be controlled by an analog output record<br>
 DAQmxBaseConfig(”portname”, “Dev1/ao0”, 0 ,”AO”, “N=1 F=0”)
</p>

</div>

<h4><a name="binary_digital_input" id="binary_digital_input">Binary/Digital Input</a></h4>
<div class="level4">

<p>
 Most cards support binary input. Like analog input you can sample 1 value or multiple values at a given samplerate.
</p>

<p>
You can setup the read to use an external port (if this is a slave-device for example)
</p>

</div>

<h4><a name="binary_digital_output" id="binary_digital_output">Binary/Digital Output</a></h4>
<div class="level4">

<p>
 Binary output.
</p>

<p>
Multiple output value or single status output is possible.
</p>

</div>

<h4><a name="counter_input" id="counter_input">Counter input</a></h4>
<div class="level4">

<p>
 There are 3 Counter in modes.<br>
 Period measurement - return value in seconds (floating point)<br>
 Count Edges - return number that is continuously growing (integer)<br>
 Pulse Width measurement - return value in seconds (floating point)
</p>

<p>
In theory you can setup these Period and Pulse Width measurement to read single or multiple values. (Most of this is untested)
</p>

<p>
1 counter channel per task. More than 1 counter task allowed.
</p>

</div>

<h4><a name="counter_output" id="counter_output">Counter output</a></h4>
<div class="level4">

<p>
 Generate a single output pulse.  Or a continuous output clock signal.
</p>

<p>
Initial delay, frequency and dutycycle are configurable. For single pulse you can also se the idle state high or low.
</p>

<p>Some cards doesn’t have counter output connectors. But they may have
internal counter signals that can be use as clock sources in other
tasks.
</p>

<p>
1 counter channel per task. More than 1 counter task allowed.
</p>

</div>
<div class="secedit"><form class="button" method="post" action="/epicsnidriverdaq"><div class="no"><input name="do" value="edit" type="hidden"><input name="lines" value="11699-14730" type="hidden"><input value="[Edit]" class="button" type="submit"></div></form></div>
<h2><a name="asyn_record_options" id="asyn_record_options">ASYN record options</a></h2>
<div class="level2">

<p>
 Please first read the section “Generic Device Support for EPICS records” in the <a href="http://medsvr.tlabs.ac.za/epicsnidriverdaq" class="urlextern" title="http://medsvr.tlabs.ac.za/epicsnidriverdaq" rel="nofollow">asynDriver manual</a>.
</p>

<p>
the DTYP field of the records can be one of:<br>
 asynInt32, asynInt32Array, asynFloat64, asynFloat64Array, asynUInt32Digital
</p>

<p>
Usually the INP or OUT field of the record is initialized.<br>
 → @asyn(portname, channelnr, timeout) Options
</p>

<p>
portname is the same as given in DAQmxBaseConfig IOC command.<br>
 channelnr will also correlate with that given in DAQmxBaseConfig.<br>
 timeout is a value in seconds, usually something like 2.0 or 5.0 is good<br>

</p>

<p>
Options are given to the driver.
</p>

<p>
The driver provides some different interfaces. And the Option parameter determine which one is used.<br>
 Here is the list:<br>

</p>
<ul>
<li class="level1"><div class="li"> DATA - This is the data interface.
Data read or written to this interface is what is read from or output
to the NI card. This is the only interface available for arrays
(waveforms)</div>
</li>
<li class="level1"><div class="li"> ACQUIRE - This is like the ON/OFF switch for the task. Writing a 1 here will start sampling/generation. A 0 will stop it.</div>
</li>
<li class="level1"><div class="li"> TRIGGERMODE - This controls the trigger mode of the task. </div>
</li>
<li class="level1"><div class="li"> SAMPLERATE - The frequency</div>
</li>
<li class="level1"><div class="li"> NSAMPLES - number of samples per channel</div>
</li>
<li class="level1"><div class="li"> MAX_NELM - This is no longer used </div>
</li>
<li class="level1"><div class="li"> MIN_VOLTS - minimum volts of channel</div>
</li>
<li class="level1"><div class="li"> MAX_VOLTS - maximum volts of channel</div>
</li>
<li class="level1"><div class="li"> D_TIME - The time of last NI read command. (only works for Input channels - Interrupts is problematic)</div>
</li>
<li class="level1"><div class="li"> STATE - The state of the state-machine is returned</div>
</li>
<li class="level1"><div class="li"> TRIGGERENABLE - enable or disable the trigger</div>
</li>
<li class="level1"><div class="li"> TRIGGERSLOPE - select rising/falling edge trigger mode.</div>
</li>
<li class="level1"><div class="li"> TRIGGERLEVEL - the voltage level of the trigger</div>
</li>
<li class="level1"><div class="li"> TRIGGERPRESAMPLES - number of samples to acquire before trigger</div>
</li>
<li class="level1"><div class="li"> TERMINAL - Controls the Termination of the Analog Input Channel. (0=default 1=RSE 2=NRSE 3=Diff)</div>
</li>
</ul>

</div>
<div class="secedit"><form class="button" method="post" action="/epicsnidriverdaq"><div class="no"><input name="do" value="edit" type="hidden"><input name="lines" value="14731-16585" type="hidden"><input value="[Edit]" class="button" type="submit"></div></form></div>
<h2><a name="custom_record" id="custom_record">Custom record</a></h2>
<div class="level2">

<p>
 None exist at this moment
</p>

</div>
<div class="secedit"><form class="button" method="post" action="/epicsnidriverdaq"><div class="no"><input name="do" value="edit" type="hidden"><input name="lines" value="16586-16639" type="hidden"><input value="[Edit]" class="button" type="submit"></div></form></div>
<h2><a name="driver_internals" id="driver_internals">Driver Internals</a></h2>
<div class="level2">

<p> This part is for people that would like to read the source-code and
maybe add features or do further development of any kind. Or if you
would like a better understanding of how the driver works
</p>

</div>

<h4><a name="quick_overview" id="quick_overview">Quick Overview</a></h4>
<div class="level4">

<p>
 The first part of the source code is defines and structures used. Then there is also defines for asyn interfaces.
</p>

<p>
Second part is all the asyn functions. Read/write ect.
</p>

<p>
Then there generator section/function
</p>

<p>
Now you get the setup functions and also the implementations of IOC functions.
</p>

<p>
Then you have the thread section.
</p>

<p>
And lastly there is the registrar setup of IOC commands.
</p>

</div>

<h4><a name="asyn_interfaces" id="asyn_interfaces">ASYN interfaces</a></h4>
<div class="level4">

<p>
 Provided interfaces:<br>

</p>
<ul>
<li class="level1"><div class="li"> Common</div>
</li>
<li class="level1"><div class="li"> DrvUser</div>
</li>
<li class="level1"><div class="li"> int32</div>
</li>
<li class="level1"><div class="li"> float64</div>
</li>
<li class="level1"><div class="li"> int32array</div>
</li>
<li class="level1"><div class="li"> float64Array</div>
</li>
<li class="level1"><div class="li"> uint32Digital</div>
</li>
</ul>

<p> The asynOption interface is not provided as there is custom IOC
commands to work with that. Most options can be accessed using PVs.
</p>

</div>

<h4><a name="state_machine" id="state_machine">State Machine</a></h4>
<div class="level4">

<p>
 Every port starts a seperate thread. This threads runs a state-machine that controls the NI card.
</p>

<p>
In source:<br>
 See enum daqMxBaseState for states.<br>
 The thread function = daqThread<br>

</p>

<p>
A pv can read the current state. Int32/Float64 interface and drvParam = STATE
</p>

</div>

<h4><a name="dual_buffering" id="dual_buffering">Dual buffering</a></h4>
<div class="level4">

<p> For input ports (Binary/Analog) there is a rawData and a prevData
buffer. These gets swapped everytime after reading. Current reading is
done in rawData. The interfaces read data from prevData. This is for
thread safety.
</p>

<p>The data pointers inside the channel structures are set to point to
prevData everytime. Data is not copied again to some other data. But
read directly from here when interface read commands are called.
</p>

</div>

<h4><a name="thread_safety" id="thread_safety">thread safety</a></h4>
<div class="level4">

<p>
 Every port has it’s own mutex (pPvt→Lock)
</p>

<p>
We are still unsure about the extend of thread-safety inside the DAQmxBase library.
</p>

</div>

<h4><a name="asyn_trace" id="asyn_trace">ASYN Trace</a></h4>
<div class="level4">

<p>
 The driver is making extensive use of the TRACE interface to output debug/error information.
</p>

<p>
For general debug and error information on a port specify with IOC:<br>
 asynSetTraceMask(”portname”, 0×11)
</p>

<p>
If you would want error information logged to a file:<br>
 asynSetTraceMask(”portname”, 0×01)<br>
 asynSetTraceFile(”portname”, “filename”)
</p>

</div>
<div class="secedit"><form class="button" method="post" action="/epicsnidriverdaq"><div class="no"><input name="do" value="edit" type="hidden"><input name="lines" value="16640-18793" type="hidden"><input value="[Edit]" class="button" type="submit"></div></form></div>
<h2><a name="examples1" id="examples1">Examples</a></h2>
<div class="level2">

</div>
<div class="secedit"><form class="button" method="post" action="/epicsnidriverdaq"><div class="no"><input name="do" value="edit" type="hidden"><input name="lines" value="18794-18815" type="hidden"><input value="[Edit]" class="button" type="submit"></div></form></div>
<h3><a name="scanner_simulation" id="scanner_simulation">Scanner Simulation</a></h3>
<div class="level3">

<p>
 Simulates a scanner and reads it back in. Connect Ao0 → Ai0 and Ao1 → Ai1
</p>

<p>
run scannersim.cmd to start this simulation.
</p>

<p>
By altering the DAQmxGen commands’ parameters inside the scannersim.cmd scriptfile the waveform generated can easily be changed.
</p>

<p>
 <a href="http://medsvr.tlabs.ac.za/_detail/epics:scannersim_ex.jpg?id=epicsnidriverdaq&amp;cache=cache" class="media" title="epics:scannersim_ex.jpg"><img src="wiki-manual_files/epicsscannersim_ex.jpg" class="media" title="scannersim_ex.jpg" alt="scannersim_ex.jpg"></a>
</p>

</div>
<div class="secedit"><form class="button" method="post" action="/epicsnidriverdaq"><div class="no"><input name="do" value="edit" type="hidden"><input name="lines" value="18816-19129" type="hidden"><input value="[Edit]" class="button" type="submit"></div></form></div>
<h2><a name="trouble_shooting" id="trouble_shooting">Trouble Shooting</a></h2>
<div class="level2">

</div>

<h4><a name="analog_signals_floating" id="analog_signals_floating">Analog signals floating</a></h4>
<div class="level4">

<p>
 Did you connect GND to the AI SENSE port on the card? - AI SENSE is the Analog Input measured GND signal<br>
 Did you setup Terminal mode correctly? - try TerminalNRSE<br>

</p>

</div>

<h4><a name="some_or_other_error" id="some_or_other_error">Some or other error</a></h4>
<div class="level4">

<p>
 Does the card support what you’re trying todo?<br>
 Not all cards can do everything. 
</p>

</div>

<h4><a name="if_you_get_a_segfault_or_some_other_critical_ioc_error" id="if_you_get_a_segfault_or_some_other_critical_ioc_error">If you get a SEGFAULT or some other critical IOC error</a></h4>
<div class="level4">

<p>
 Please put the output into a file. <br>
 Also include the .db file and the startup script your using and any other information.<br>
 Also specifiy which NI card you are using.<br>
 Send this information to <a href="mailto:heinrichdt@tlabs.ac.za" class="mail JSnocheck" title="heinrichdt@tlabs.ac.za">heinrichdt@tlabs.ac.za</a> or <a href="mailto:ulrik.pederson@diamond.ac.uk" class="mail JSnocheck" title="ulrik.pederson@diamond.ac.uk">ulrik.pederson@diamond.ac.uk</a>
</p>

</div>

<h4><a name="if_you_want_to_do_something_else" id="if_you_want_to_do_something_else">If you want to do something else</a></h4>
<div class="level4">

<p>
 Cool. Show us how! 
</p>

</div>
<div class="secedit"><form class="button" method="post" action="/epicsnidriverdaq"><div class="no"><input name="do" value="edit" type="hidden"><input name="lines" value="19130-" type="hidden"><input value="[Edit]" class="button" type="submit"></div></form></div>
<!-- cachefile /udd0/home/www/html/data/cache/2/2bef3f5449e9c6805ece97b0b3298754.xhtml used -->
<br>
														<!-- end content -->
							<div class="visualClear"></div>
						</div>
					</div>
				</div>
			</div>

			<div id="column-one">
				<div class="portlet" id="p-logo">
					<a style="background-image: url(/lib/tpl/monobook/user/logo.png);" href="http://medsvr.tlabs.ac.za/" accesskey="h" title="[ALT+H]">
					</a>
				</div>

				<div id="p-cactions" class="portlet"> <h5>Views</h5>   <ul>
<li id="ca-article" class="selected"><span class="curid"><a href="http://medsvr.tlabs.ac.za/epicsnidriverdaq" class="wikilink1" title="epicsnidriverdaq">Article</a></span></li>
<li id="ca-talk"><a href="http://medsvr.tlabs.ac.za/talk:epicsnidriverdaq" class="wikilink2" title="talk:epicsnidriverdaq">Discussion</a></li>
<li id="ca-edit"><a href="http://medsvr.tlabs.ac.za/doku.php?id=epicsnidriverdaq&amp;do=edit&amp;rev=1187871694" accesskey="e" title="[ALT+E]">Edit this page</a></li>
<li id="ca-history"><a href="http://medsvr.tlabs.ac.za/doku.php?id=epicsnidriverdaq&amp;do=revisions" accesskey="o" title="[ALT+O]">Old revisions</a></li>
   </ul>
</div>				<div id="p-navigation" class="portlet"> <h5>Navigation</h5>  <div class="pBody"><ul>
<li class="level1"><div class="li"> <a href="http://medsvr.tlabs.ac.za/start" class="wikilink1" title="start">start</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://medsvr.tlabs.ac.za/doku.php?do=recent" class="urlextern" title="http://medsvr.tlabs.ac.za/doku.php?do=recent" rel="nofollow">Recent Changes</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://medsvr.tlabs.ac.za/wiki:dokuwiki" class="wikilink1" title="wiki:dokuwiki">Help</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://medsvr.tlabs.ac.za/doku.php?do=index" class="urlextern" title="http://medsvr.tlabs.ac.za/doku.php?do=index" rel="nofollow">Site map</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://medsvr.tlabs.ac.za/epics" class="wikilink1" title="epics">epics</a></div>
</li>
</ul>

<!-- cachefile /udd0/home/www/html/data/cache/e/ed843ad0d3a303dcbac9b2c52f204909.xhtml used -->
<div class="secedit2"><a href="http://medsvr.tlabs.ac.za/doku.php?id=:wiki:navigation&amp;do=edit&amp;rev=1187871694">[Edit]</a></div>  </div></div>				
				<div id="p-search" class="portlet">
					<h5><label for="searchInput">Search</label></h5>
					<div class="pBody">
						<form action="/doku.php" accept-charset="utf-8" id="searchform" name="search">
							<input name="do" value="search" type="hidden">
							<input id="searchInput" name="id" accesskey="f" value="" type="text">
							<input class="searchButton" id="searchGoButton" value="Go" type="submit">&nbsp;<input name="fulltext" class="searchButton" value="Search" type="submit">
						</form>
					</div>
				</div>

				<div id="p-tb" class="portlet"> <h5>Toolbox</h5>  <div class="pBody">   <ul>
<li id="tb-whatlinkshere"><a href="http://medsvr.tlabs.ac.za/doku.php?id=epicsnidriverdaq&amp;do=backlink" rel="nofollow">What links here</a></li>
<li id="tb-upload"><a href="http://medsvr.tlabs.ac.za/lib/exe/media.php?ns=" rel="nofollow">Upload file</a></li>
<li id="tb-special"><a href="http://medsvr.tlabs.ac.za/doku.php?idx=wiki" rel="nofollow">Special Page</a></li>
<li id="tb-print"><a href="http://medsvr.tlabs.ac.za/doku.php?id=epicsnidriverdaq&amp;rev=1187871694&amp;mbdo=print" rel="nofollow">Printable Version</a></li>
<li id="tb-permanent"><a href="http://medsvr.tlabs.ac.za/doku.php?id=epicsnidriverdaq&amp;rev=1187871694" rel="nofollow">Permanant link</a></li>
<li id="tb-cite"><a href="http://medsvr.tlabs.ac.za/doku.php?id=epicsnidriverdaq&amp;rev=1187871694&amp;mbdo=cite" rel="nofollow">Cite this Article</a></li>
   </ul>
  </div></div>				
			</div>
			<!-- end of the left (by default at least) column -->
			<div class="visualClear"></div>
      <div id="footer">
	  <div id="f-copyrightico"><a target="_blank" href="http://tatewake.com/wiki/projects:monobook_for_dokuwiki" title="Monobook for DokuWiki"><img src="wiki-manual_files/button-mb.png" alt="Monobook for DokuWiki" border="0" height="31" width="88"></a></div>
	  <div id="f-poweredbyico"><a target="_blank" href="http://wiki.splitbrain.org/wiki:dokuwiki" title="Driven by DokuWiki"><img src="wiki-manual_files/button-dw.png" alt="Driven by DokuWiki" border="0" height="31" width="88"></a></div>
        <a target="_blank" href="http://medsvr.tlabs.ac.za/feed.php" title="Recent changes RSS feed"><img src="wiki-manual_files/button-rss.png" alt="Recent changes RSS feed" border="0" height="15" width="80"></a>
        <a target="_blank" href="http://www.php.net/" title="Powered by PHP"><img src="wiki-manual_files/button-php.gif" alt="Powered by PHP" border="0" height="15" width="80"></a>
        <a target="_blank" href="http://validator.w3.org/check/referer" title="Valid XHTML 1.0"><img src="wiki-manual_files/button-xhtml.png" alt="Valid XHTML 1.0" border="0" height="15" width="80"></a>
        <a target="_blank" href="http://jigsaw.w3.org/css-validator/check/referer" title="Valid CSS"><img src="wiki-manual_files/button-css.png" alt="Valid CSS" border="0" height="15" width="80"></a>
	      <ul id="f-list">
	        <li id="f-lastmod">epicsnidriverdaq.txt · Last modified: 2007/08/23 14:21 by 196.21.126.246<br></li>
	        <li id="f-copyright"><div class="secedit2"><a href="http://medsvr.tlabs.ac.za/doku.php?id=:wiki:copyright&amp;do=edit&amp;rev=1187871694">Create this page</a></div></li>
	        <li id="f-usermod"><br></li>
	      </ul>
      </div>
		</div>
		<img src="wiki-manual_files/indexer.gif" alt="" height="1" width="1">	</body></html>